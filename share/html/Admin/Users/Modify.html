%# BEGIN BPS TAGGED BLOCK {{{
%# 
%# COPYRIGHT:
%# 
%# This software is Copyright (c) 1996-2008 Best Practical Solutions, LLC
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/licenses/old-licenses/gpl-2.0.html.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# END BPS TAGGED BLOCK }}}
<& /Admin/Elements/Header, title => $title  &>
<& /Admin/Elements/UserTabs, 
    id => $id, 
    user_object => $user_object,
    current_tab => $current_tab, 
    title => $title &>

<& /Elements/ListActions, actions => \@results &>

<form action="<%RT->config->get('WebPath')%>/Admin/Users/Modify.html" method="post" enctype="multipart/form-data">
%if ($create) {
<input type="hidden" class="hidden" name="id" value="new" />
% } else {
<input type="hidden" class="hidden" name="id" value="<%$user_object->id%>" />
% }
<table width="100%" border="0">
<tr>

<td valign="top" class="boxcontainer">
<&| /Widgets/TitleBox, title => _('Identity') &>

<table>
<tr><td align="right">
<&|/l&>Username</&>:
</td><td>
<input name="name" value="<%$user_object->name%>" /> <strong><&|/l&>(required)</&></strong>
</td></tr>
<tr><td align="right">
<&|/l&>Email</&>:
</td><td>
<input name="email" value="<%$user_object->email%>" />
</td></tr>
<tr><td align="right">
<&|/l&>Real name</&>: 
</td><td>
<input name="real_name" value="<%$user_object->real_name%>" />
</td></tr>
<tr><td align="right">
<&|/l&>nickname</&>: 
</td><td>
<input name="nickname" value="<%$user_object->nickname%>" />
</td></tr>
<tr><td align="right">
<&|/l&>unix login</&>: 
</td><td>
<input name="gecos" value="<%$user_object->gecos%>" />
</td></tr>
<tr><td align="right">
<&|/l&>Language</&>: 
</td><td>
<& /Elements/SelectLang, name => 'lang', default => $user_object->lang &>
</td></tr>
<tr><td align="right">
<&|/l&>Extra info</&>: 
</td><td>
<textarea name="freeform_contact_info" cols="20" rows="5"><%$user_object->freeform_contact_info%></textarea>
</td></tr>
</table>
</&>
<br />
<&| /Widgets/TitleBox, title => _('Access control') &>
<input type="hidden" class="hidden" name="set_enabled" value="1" />
<input type="checkbox" class="checkbox" name="enabled" value="1" <%$enabled_checked%> />
<&|/l&>Let this user access RT</&><br />


<input type="hidden" class="hidden" name="set_privileged" value="1" />
<input type="checkbox" class="checkbox" name="privileged" value="1" <%$privilegedChecked%> /> <&|/l&>Let this user be granted rights</&><br />
		    
% unless (RT->config->get('WebExternalAuth') and !RT->config->get('WebFallbackToInternalAuth')) {
<table>
<tr>
<td align="right">
<&|/l&>New password</&>:
</td>
<td align="left">
<input type="password" name="pass1" autocomplete="off" />
</td>
</tr>
<tr><td align="right">
<&|/l&>Retype password</&>:
</td>
<td>
<input type="password" name="pass2" autocomplete="off" />
</td>
</tr>
</table>
% }
</&>
% $m->callback( %ARGS, Callbackname => 'left_column_bottom', user_object => $user_object );
</td>

<td valign="top" class="boxcontainer">
<&| /Widgets/TitleBox, title => _('Location') &>
<table>
<tr><td align="right">
<&|/l&>organization</&>: 
</td><td>
<input name="organization" value="<%$user_object->organization%>" />
</td></tr>
<tr><td align="right">
<&|/l&>Address1</&>: 
</td><td>
<input name="address1" value="<%$user_object->address1%>" />
</td></tr>
<tr><td align="right">
<&|/l&>Address2</&>: 
</td><td>
<input name="address2" value="<%$user_object->address2%>" />
</td></tr>
<tr><td align="right">
<&|/l&>City</&>: 
</td><td>
<input name="city" value="<%$user_object->city%>" size="14" />

</td></tr>
<tr><td align="right">
<&|/l&>State</&>: 
</td><td>
<input name="state" value="<%$user_object->state%>" size="3" />

</td></tr>
<tr><td align="right">
<&|/l&>Zip</&>: 
</td><td>
<input name="zip" value="<%$user_object->zip%>" size="9" />
</td></tr>
<tr><td align="right">
<&|/l&>Country</&>: 
</td><td>
<input name="country" value="<%$user_object->country%>" />
</td></tr>
</table>
</&>
<br />
<&| /Widgets/TitleBox, title => _('Phone numbers') &>
<table>
<tr><td align="right">
<&|/l&>Residence</&>: 
</td><td>
<input name="home_phone" value="<%$user_object->home_phone%>" size="13" /><br />
</td></tr>
<tr><td align="right">
<&|/l&>Work</&>: 
</td><td>
<input name="work_phone" value="<%$user_object->work_phone%>" size="13" /><br />
</td></tr>
<tr><td align="right">
<&|/l&>Mobile</&>: 
</td><td>
<input name="mobile_phone" value="<%$user_object->mobile_phone%>" size="13" /><br />
</td></tr>
<tr><td align="right">
<&|/l&>Pager</&>: 
</td><td>
<input name="pager_phone" value="<%$user_object->pager_phone%>" size="13" /><br />
</td>
</tr>
</table>
</&>
<br />
<&| /Widgets/TitleBox, title => _('Custom Fields') &>
<table>
% my $CFs = $user_object->custom_fields;
% while (my $CF = $CFs->next) {
<tr valign="top"><td align="right">
<% $CF->name %>:
</td><td>
% if ($user_object->id) {
<& /Elements/EditCustomField, %ARGS, object => $user_object, custom_field => $CF &>
% } else {
<& /Elements/EditCustomField, %ARGS, name_prefix => 'object-RT::Model::User-new-CustomField-', custom_field => $CF &>
% }
</td></tr>
% }
</table>
</&>
% $m->callback( %ARGS, Callbackname => 'right_column_bottom', user_object => $user_object );
</td></tr>
<tr>
<td colspan="2">
<&| /Widgets/TitleBox, title => _('comments about this user') &>
<textarea class="comments" name="comments" cols="80" rows="5" wrap="virtual"><%$user_object->comments%></textarea>
</&>
%if (!$create && $user_object->privileged) {
<br />
<&| /Widgets/TitleBox, title => _('Signature') &>
<textarea class="signature" cols="80" rows="5" name="signature" wrap="hard"><%$user_object->signature%></textarea>
</&>
% }

</td>
</tr>
</table>

<& /Elements/Submit, label => _('Save Changes') &>
</form>

<%INIT>

my $current_tab;
my $user_object = RT::Model::User->new();
my ($title, $privilegedChecked, $enabled_checked, $disabled, $result, @results);

my ($val, $msg);

if ($create) {
    $current_tab = 'Admin/Users/Modify.html?Create=1';
    $title = _("Create a new user");
} 
else {

    if ($id =~ /^\d+$/) { 
        $current_tab = 'Admin/Users/Modify.html?id='.$id;
    } elsif ($id eq 'new') {
	( $val, $msg ) = $user_object->create(
	    name                  => $name,
	    email          => $ARGS{'email'},
	    name                  => $ARGS{'name'},
	    comments              => $ARGS{'comments'},
	    Signature             => $ARGS{'signature'},
	    email          => $ARGS{'email'},
	    freeform_contact_info   => $ARGS{'freeform_contact_info'},
	    organization          => $ARGS{'organization'},
	    real_name              => $ARGS{'real_name'},
	    nickname              => $ARGS{'nickname'},
	    lang                  => $ARGS{'lang'},
	    email_encoding         => $ARGS{'email_encoding'},
	    web_encoding           => $ARGS{'web_encoding'},
	    ExternalContactInfoId => $ARGS{'external_contact_info_id'},
	    ContactInfoSystem     => $ARGS{'contact_info_system'},
	    gecos                 => $ARGS{'gecos'},
	    ExternalAuthId        => $ARGS{'external_auth_id'},
	    auth_system            => $ARGS{'auth_system'},
	    HomePhone             => $ARGS{'home_phone'},
	    WorkPhone             => $ARGS{'work_phone'},
	    MobilePhone           => $ARGS{'mobile_phone'},
	    PagerPhone            => $ARGS{'pager_phone'},
	    Address1              => $ARGS{'address1'},
	    Address2              => $ARGS{'address2'},
	    City                  => $ARGS{'city'},
	    State                 => $ARGS{'state'},
	    Zip                   => $ARGS{'zip'},
	    Country               => $ARGS{'country'},
	    privileged           => $ARGS{'privileged'},
	    disabled            => ($ARGS{'enabled'} ? 0 : 1)
	);

	if ($val) {
		push @results, $msg;
        foreach my $key ( keys %ARGS) {
            # Convert custom fields on the "new" object to custom fields on the one we've just Created
            if ($key =~ /^object-RT::Model::User-new-CustomField-(.*)$/) {
            $ARGS{'object-RT::Model::User-'.$val.'-CustomField-'.$1} = delete $ARGS{$key};
            }
        }
        push @results, process_object_custom_field_updates( args_ref => \%ARGS, object => $user_object );
	} else {
		push @results, _('User could not be Created: %1', $msg);
	}
    } else {
	    $user_object->load($id) || $user_object->load($name) || abort("Couldn't load user '$name'");
        $val = $user_object->id();
    }

    if ($val) {
	$title = _("Modify the user %1", $user_object->name);
    }

    # If the create failed
    else {
	$title = _("Create a new user");
	$create = 1;
    }
}




# If we have a user to modify, lets try. 
if ($user_object->id && $id ne 'new') {

    my @fields = qw(name comments Signature email freeform_contact_info 
		    organization real_name nickname lang email_encoding web_encoding 
		    ExternalContactInfoId ContactInfoSystem gecos ExternalAuthId 
		    auth_system HomePhone WorkPhone MobilePhone PagerPhone Address1
		    Address2 City State Zip Country 
		   );

    my @fieldresults = update_record_object ( attributes_ref => \@fields,
					    object => $user_object,
					    args_ref => \%ARGS );
    push (@results,@fieldresults);
    push @results, process_object_custom_field_updates( args_ref => \%ARGS, object => $user_object );


    # {{{ Deal with special fields: privileged, enabled
    if  ( $set_privileged and $privileged != $user_object->privileged ) {
         my ($code, $msg) = $user_object->set_privileged($privileged);
         push @results, _('privileged status: %1', _($msg));
    }

    #we're asking about enabled on the web page but really care about disabled.
    $disabled = $enabled ? 0 : 1;

    if  ( ($set_enabled) and ( $disabled != $user_object->disabled) ) { 
        my  ($code, $msg) = $user_object->set_disabled($disabled);
        push @results, _('enabled status %1', _($msg));
    }


    # }}}
}

if ( $user_object->id ) {
    my $password_not_set;
    # Deal with password field
    if ( !$pass1 and !$pass2 ) {
	$password_not_set = 1;
    } elsif ( $pass1 ne $pass2 ) {
	$password_not_set = 1;
        push @results, _("passwords do not match.");
    } elsif ( $pass1 eq $pass2 and $user_object->password ne $pass1 ) {
        my ($code, $msg) = $user_object->set_password($pass1);
        push @results, _($msg);
	$password_not_set = 1 unless $code;
    }
    if ($id eq 'new' and $password_not_set) {
	push @results, _("A password was not set, so user won't be able to login.");
    } 
}


# Do some setup for the ui
unless ( $user_object->id && $user_object->disabled ) {
    $enabled_checked = 'checked="checked"';
}

if (!$create && $user_object->privileged()) {  
    $privilegedChecked = 'checked="checked"';
}

# set the id, so the the menu will have the right info, this needs to
# be done here to avoid creating and then modifying a user
$id = $user_object->id;

</%INIT>


<%ARGS>
$id => undef
$name  => undef
$comments  => undef
$signature  => undef
$email  => undef
$freeform_contact_info => undef
$organization  => undef
$real_name  => undef
$nickname  => undef
$privileged => undef
$set_privileged => undef
$enabled => undef
$set_enabled => undef
$lang  => undef
$email_encoding  => undef
$web_encoding => undef
$external_contact_info_id  => undef
$contact_info_system  => undef
$gecos => undef
$external_auth_id  => undef
$auth_system  => undef
$home_phone => undef
$work_phone  => undef
$mobile_phone  => undef
$pager_phone  => undef
$address1 => undef
$address2  => undef
$city  => undef
$state  => undef
$zip  => undef
$country => undef
$pass1 => undef
$pass2=> undef
$create=> undef
</%ARGS>
