%# BEGIN BPS TAGGED BLOCK {{{
%# 
%# COPYRIGHT:
%# 
%# This software is Copyright (c) 1996-2008 Best Practical Solutions, LLC
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/licenses/old-licenses/gpl-2.0.html.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# END BPS TAGGED BLOCK }}}
<& /Elements/Header, title => $title &>
<& /Ticket/Elements/Tabs, 
    current_tab => "Search/Bulk.html",
    title => $title,
    format => $ARGS{'format'}, # we don't want the locally modified one
    query => $query,
    rows => $rows,
    order_by => $order_by,
    order => $order,
    saved_searchid => $saved_searchid &>

<& /Elements/ListActions, actions => \@results &>
<form method="post" action="<% RT->config->get('WebPath') %>/Search/Bulk.html" enctype="multipart/form-data">
% foreach my $var qw(query format order_by order Rows Page) {
<input type="hidden" class="hidden" name="<%$var%>" value="<%$ARGS{$var} || ''%>" />
%}
<& /Elements/CollectionList, query => $query,
    display_format => $format,
    format => $ARGS{'format'},
    verbatim => 1,
    allow_sorting => 1,
    order_by => $order_by,
    order => $order,
    rows => $rows,
    page => $page,
    base_url => RT->config->get('WebPath')."/Search/Bulk.html?",
    class => 'RT::Model::TicketCollection'
   &>

% $m->callback(Callbackname => 'AfterTicketList', args_ref => \%ARGS);

<hr />

<& /Elements/Submit, label => _('Update'), check_all => 1, clear_all => 1 &>
<br />
<&|/Widgets/TitleBox, title => $title &>
<table>
<tr>
<td valign="top">
<table>
<tr><td class="label"> <&|/l&>Make Owner</&>: </td>
<td class="value"> <& /Elements/SelectOwner, name => "owner" &> (<input type="checkbox" class="checkbox" name="force_owner_change" /> <&|/l&>Force change</&>) </td></tr>
<tr><td class="label"> <&|/l&>add Requestor</&>: </td>
<td class="value"> <input name="AddRequestor" size="20" /> </td></tr>
<tr><td class="label"> <&|/l&>Remove Requestor</&>: </td>
<td class="value"> <input name="DeleteRequestor" size="20" /> </td></tr>
<tr><td class="label"> <&|/l&>add Cc</&>: </td>
<td class="value"> <input name="AddCc" size="20" /> </td></tr>
<tr><td class="label"> <&|/l&>Remove Cc</&>: </td>
<td class="value"> <input name="DeleteCc" size="20" /> </td></tr>
<tr><td class="label"> <&|/l&>add AdminCc</&>: </td>
<td class="value"> <input name="AddAdminCc" size="20" /> </td></tr>
<tr><td class="label"> <&|/l&>Remove AdminCc</&>: </td>
<td class="value"> <input name="DeleteAdminCc" size="20" /> </td></tr>
</table>
</td>
<td valign="top">
<table>
<tr><td class="label"> <&|/l&>Make subject</&>: </td>
<td class="value"> <input name="subject" size="20" /> </td></tr>
<tr><td class="label"> <&|/l&>Make priority</&>: </td>
<td class="value"> <input name="Priority" size="4" /> </td></tr>
<tr><td class="label"> <&|/l&>Make queue</&>: </td>
<td class="value"> <& /Elements/SelectQueue, name => "queue" &> </td></tr>
<tr><td class="label"> <&|/l&>Make Status</&>: </td>
<td class="value"> <& /Elements/SelectStatus, name => "status" &> </td></tr>
<tr><td class="label"> <&|/l&>Make date starts</&>: </td>
<td class="value"> <& /Elements/SelectDate, name => "starts_date", show_time => 0, default => '' &> </td></tr>
<tr><td class="label"> <&|/l&>Make date Started</&>: </td>
<td class="value"> <& /Elements/SelectDate, name => "started_date", show_time => 0, default => '' &> </td></tr>
<tr><td class="label"> <&|/l&>Make date Told</&>: </td>
<td class="value"> <& /Elements/SelectDate, name => "told_date", show_time => 0, default => '' &> </td></tr>
<tr><td class="label"> <&|/l&>Make date Due</&>: </td>
<td class="value"> <& /Elements/SelectDate, name => "due_date", show_time => 0, default => '' &> </td></tr>
<tr><td class="label"> <&|/l&>Make date Resolved</&>: </td>
<td class="value"> <& /Elements/SelectDate, name => "resolved_date", show_time => 0, default => '' &> </td></tr>
</table>

</td>
</tr>
</table>
</&>
<&| /Widgets/TitleBox, title => _('Add comments or replies to selected tickets') &>
<table>
<tr><td align="right"><&|/l&>update Type</&>:</td>
<td><select name="UpdateType">
  <option value="private" ><&|/l&>comments (not sent to requestors)</&></option>
<option value="response" ><&|/l&>Reply to requestors</&></option>
</select> 
</td></tr>
<tr><td align="right"><&|/l&>subject</&>:</td><td> <input name="Updatesubject" size="60" value="" /></td></tr>
% while (my $CF = $TxnCFs->next()) {
<tr>
<td align="right"><% $CF->name %>:</td>
<td><& /Elements/EditCustomField, 
    custom_field => $CF, 
    name_prefix => "object-RT::Model::Transaction--CustomField-"
    &><em><% $CF->friendly_type %></em></td>
</td></tr>
% } # end if while
 <tr><td align="right"><&|/l&>Attach</&>:</td><td><input name="UpdateAttachment" type="file" /></td></tr>
 <tr><td class="labeltop"><&|/l&>Message</&>:</td><td>
 <& /Elements/MessageBox, name=>"update_content"&>
 </td></tr>
 </table>

</&>

<%perl>
my $cfs = RT::Model::CustomFieldCollection->new();
$cfs->limit_to_global();
$cfs->limit_to_queue($_) for keys %$seen_queues;
</%perl>

% if ($cfs->count) {
<&|/Widgets/TitleBox, title => _('Edit Custom Fields'), color => "#336633"&>
<table>
<tr>
<th><&|/l&>name</&></th>
<th><&|/l&>add values</&></th>
<th><&|/l&>delete values</&></th>
</tr>
% while (my $cf = $cfs->next()) {
<tr>
<td class="label"><%$cf->name%><br />
<em>(<%$cf->friendly_type%>)</em></td>
% my $rows = 5;
% my @add = (name_prefix => 'Bulk-Add-CustomField-', custom_field => $cf, rows => $rows, Multiple => ($cf->max_values ==1 ? 0 : 1) , Cols => 25);
% my @del = (name_prefix => 'Bulk-Delete-CustomField-', custom_field => $cf, rows => $rows, Multiple => 1, Cols => 25);
% if ($cf->type eq 'Select') {
<td><& /Elements/EditCustomFieldSelect, @add &></td>
<td><& /Elements/EditCustomFieldSelect, @del &></td>
% } elsif ($cf->type eq 'Combobox') {
<td><& /Elements/EditCustomFieldCombobox, @add &></td>
<td><& /Elements/EditCustomFieldCombobox, @del &></td>
% } elsif ($cf->type eq 'Freeform') {
<td><& /Elements/EditCustomFieldFreeform, @add &></td>
<td><& /Elements/EditCustomFieldFreeform, @del &></td>
% } elsif ($cf->type eq 'Text') {
<td><& /Elements/EditCustomFieldText, @add &></td>
<td>&nbsp;</td>
% } else {
%   Jifty->log->fatal("Unknown CustomField type: " . $cf->type);
% }
</tr>
% }
</table>
</&>
% }

<&|/Widgets/TitleBox, title => _('Edit Links'), color => "#336633"&>
<em><&|/l&>Enter tickets or URIs to link tickets to. Separate multiple entries with spaces.</&></em><br />
<& /Ticket/Elements/BulkLinks &>
</&>

<& /Elements/Submit, label => _('Update') &>


</form>


<%INIT>
$rows = $rows_per_page unless (defined $rows);
my $title = _("Update multiple tickets");

# Iterate through the ARGS hash and remove anything with a null value.
map ( $ARGS{$_} =~ /^$/ && ( delete $ARGS{$_} ), keys %ARGS );

my (@results);

$page ||= 1;

$format ||= RT->config->get('DefaultSearchResultFormat');

# inject _CHECKBOX to the first field.
$format =~ s/'?([^']+)'?,/'___CHECKBOX__$1',/;

my $Tickets = RT::Model::TicketCollection->new();
$Tickets->from_sql($query);
if ( $order_by =~ /\|/ ) {

  # Multiple Sorts
  my @order_by = split /\|/, $order_by;
  my @order   = split /\|/, $order;
  $Tickets->order_by(
    map { { column => $order_by[$_], order => $order[$_] } }
      ( 0 .. $#order_by ) );
}
else {
  $Tickets->order_by( column => $order_by, order => $order );
}

$page = 1 unless $page && $page > 0; # workaround problems with Page = '' or undef
$Tickets->set_page_info(per_page => $rows, current_page => $page);

abort( _("No search to operate on.") ) unless ($Tickets);

# build up a list of all custom fields for tickets that we're displaying, so
# we can display sane edit widgets.

my $fields      = {};
my $seen_queues = {};
while ( my $ticket = $Tickets->next ) {
    next if $seen_queues->{ $ticket->queue }++;

    my $custom_fields = $ticket->queue_obj->ticket_custom_fields;
    while ( my $field = $custom_fields->next ) {
        $fields->{ $field->id } = $field;
    }
}

#Iterate through each ticket we've been handed
my @linkresults;
my %queues;

$Tickets->redo_search();

# pull out the labels for any custom fields we want to update

my $cf_del_keys;
@$cf_del_keys = grep { /^Bulk-Delete-CustomField/ } keys %ARGS;
my $cf_add_keys;
@$cf_add_keys = grep { /^Bulk-Add-CustomField/ } keys %ARGS;


while ( my $Ticket = $Tickets->next ) {
    next unless ( $ARGS{ "UpdateTicket" . $Ticket->id } );

    #Update the links
    $ARGS{'id'} = $Ticket->id;
    $queues{ $Ticket->queue_obj->id }++;

    my @updateresults, process_update_message(
            ticket_obj => $Ticket,
            args_ref   => \%ARGS,
        );

    #Update the basics.
    my @basicresults =
      process_ticket_basics( ticket_obj => $Ticket, args_ref => \%ARGS );
    my @dateresults =
      process_ticket_dates( ticket_obj => $Ticket, args_ref => \%ARGS );

    #Update the watchers
    my @watchresults =
      process_ticket_watchers( ticket_obj => $Ticket, args_ref => \%ARGS );

    foreach my $type qw(MergeInto DependsOn MemberOf RefersTo) {
        $ARGS{ $Ticket->id . "-" . $type } = $ARGS{"Ticket-$type"};
        $ARGS{ $type . "-" . $Ticket->id } = $ARGS{"$type-Ticket"};
    }
    @linkresults =
      process_ticket_links( ticket_obj => $Ticket, args_ref => \%ARGS );
    foreach my $type qw(MergeInto DependsOn MemberOf RefersTo) {
        delete $ARGS{ $type . "-" . $Ticket->id };
        delete $ARGS{ $Ticket->id . "-" . $type };
    }

    my @cfresults;

    foreach my $list ( $cf_add_keys, $cf_del_keys ) {
        next unless $list->[0];


        my $op;
        if ( $list->[0] =~ /Add/ ) {
            $op = 'add';

        }
        elsif ( $list->[0] =~ /Del/ ) {
            $op = 'del';
        }
        else {
            Jifty->log->fatal(
                "Got an op that was neither add nor delete. can never happen"
                  . $list->[0] );
            last;
        }

        foreach my $key (@$list) {
            my ( $cfid, $cf );
            next if $key =~ /CustomField-(\d+)-Category$/;
            if ( $key =~ /CustomField-(\d+)-/ ) {
                $cfid = $1;
                $cf   = RT::Model::CustomField->new();
                $cf->load($cfid);
            }
            else {next}
            my @values =
              ref( $ARGS{$key} ) eq 'ARRAY'
              ? @{ $ARGS{$key} }
              : ( $ARGS{$key} );
            map { s/(\r\n|\r)/\n/g; } @values;    # fix the newlines
                 # now break the multiline values into multivalues
            @values = map { split( /\n/, $_ ) } @values
              unless ( $cf->single_value );

            my $current_values = $Ticket->custom_field_values($cfid);
            foreach my $value (@values) {
                if ( $op eq 'del' && $current_values->has_entry($value) ) {
                    my ( $id, $msg ) = $Ticket->delete_custom_field_value(
                        column => $cfid,
                        value => $value
                    );
                    push @cfresults, $msg;
                }

                elsif ( $op eq 'add' && !$current_values->has_entry($value) ) {
                    my ( $id, $msg ) = $Ticket->add_custom_field_value(
                        column => $cfid,
                        value => $value
                    );
                    push @cfresults, $msg;
                }
            }
        }
    }
    my @tempresults = (
        @watchresults,  @basicresults, @dateresults,
        @updateresults, @linkresults,  @cfresults
    );

    @tempresults =
      map { _( "Ticket %1: %2", $Ticket->id, $_ ) } @tempresults;

    @results = ( @results, @tempresults );
}

my $TxnCFs = RT::Model::CustomFieldCollection->new();
$TxnCFs->limit_to_lookup_type( RT::Model::Transaction->custom_field_lookup_type );
$TxnCFs->limit_to_global_or_object_id( sort keys %queues );

</%INIT>
<%args>
$format => undef
$page => 1
$rows => 50
$rows_per_page => undef
$order => 'ASC'
$order_by => 'id'
$query => undef
$saved_searchid => undef
</%args>
