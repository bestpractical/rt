language: bash
services: docker
os: linux

notifications:
  slack:
    secure: ebb/6lbr1ob7wMh04C5PzM5/NNz6IstEUaUROA7BATuKKgPetl6qwmQNwvlwE5zYvJQBWQwKJ70JaCzJkXK6JVMVRRAWsXINJTzMfSqsoXEcJ59c5isf0bsnspVO7jxHTfXF/NZngR4EuPwH5v5lWp9m++j90t9nBKFFVi34WUE=

jobs:
  include:
  - stage: test
    name: Test against SQLite with default web handler
    env:
      - RT_TEST_PARALLEL=1 RT_DBA_USER=root RT_DBA_PASSWORD=password DB_VERSION_TAG=10.3

    before_install:
      - docker build -t rt-base .
      - docker run -d -e RT_DBA_USER=root -e RT_DBA_PASSWORD=password -v $TRAVIS_BUILD_DIR:/rt --name rt rt-base
      - docker ps -a
      - docker exec -it rt bash -c "cd /rt && ./configure.ac --with-db-type=SQLite --with-my-user-group --enable-layout=inplace --enable-developer --enable-externalauth --disable-gpg --disable-smime && mkdir -p /rt/var && make testdeps"

    script:
        - docker exec -it rt bash -c "cd /rt && prove -lj9 t/*"

  - stage: test
    name: Test against MariaDB and Apache with mod_fcgid
    env:
      - RT_TEST_PARALLEL=1 RT_DBA_USER=root RT_DBA_PASSWORD=password DB_VERSION_TAG=10.3

    before_install:
      - docker run --name mariadb -e MYSQL_ROOT_PASSWORD=password -d mariadb:$DB_VERSION_TAG
      - docker build -t rt-base .
      - docker run -d -e RT_DBA_USER=root -e RT_DBA_PASSWORD=password -e RT_TEST_WEB_HANDLER=apache+fcgid -e HTTPD_ROOT=/etc/apache2 -e RT_TEST_APACHE=/usr/sbin/apache2 -e RT_TEST_APACHE_MODULES=/usr/lib/apache2/modules -v $TRAVIS_BUILD_DIR:/rt --name rt --link mariadb:db rt-base
      - docker ps -a
      - docker exec -it rt bash -c "chown -R rt-test /rt; touch /etc/apache2/mime.types"
      - docker exec -e USER=rt-test -u rt-test -it rt bash -c "cd /rt && ./configure.ac --with-db-type=mysql --enable-layout=inplace --with-my-user-group --enable-developer --enable-externalauth --disable-gpg --disable-smime --with-web-handler=fcgid && mkdir -p /rt/var && make testdeps && chmod a+rX /rt/sbin/*"

    script:
        - docker exec -e USER=rt-test -u rt-test -it rt bash -c "cd /rt &&prove -lj9 t/*"

  - stage: test
    name: Test against PostgreSQL and Apache with mod_fcgid
    env:
      - RT_TEST_PARALLEL=1 RT_DBA_USER=postgres RT_DBA_PASSWORD=password DB_VERSION_TAG=9.6

    before_install:
      - docker run --name postgresql --mount type=tmpfs,destination=/var/lib/postgresql/data -e POSTGRES_PASSWORD=password -d postgres:$DB_VERSION_TAG
      - docker build -t rt-base .
      - docker run -d -e RT_DBA_USER=postgres -e RT_DBA_PASSWORD=password -e RT_TEST_WEB_HANDLER=apache+fcgid -e HTTPD_ROOT=/etc/apache2 -e RT_TEST_APACHE=/usr/sbin/apache2 -e RT_TEST_APACHE_MODULES=/usr/lib/apache2/modules -v $TRAVIS_BUILD_DIR:/rt --name rt --link postgresql:db rt-base
      - docker ps -a
      - docker exec -it rt bash -c "chown -R rt-test /rt; touch /etc/apache2/mime.types"
      - docker exec -e USER=rt-test -u rt-test -it rt bash -c "cd /rt && ./configure.ac --with-db-type=Pg --enable-layout=inplace --with-my-user-group --enable-developer --enable-externalauth --disable-gpg --disable-smime --with-web-handler=fcgid && mkdir -p /rt/var && make testdeps && chmod a+rX /rt/sbin/*"

    script:
        - docker exec -e USER=rt-test -u rt-test -it rt bash -c "cd /rt && prove -lj9 t/*"
