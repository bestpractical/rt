%# {{{ BEGIN BPS TAGGED BLOCK
%# 
%# COPYRIGHT:
%#  
%# This software is Copyright (c) 1996-2004 Best Practical Solutions, LLC 
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# }}} END BPS TAGGED BLOCK
<& /Elements/Header, Title => loc("Bulk ticket update") &>
<& /Elements/Tabs, Title => loc("Bulk ticket update") &>

<& /Elements/ListActions, actions => \@results &>

<FORM METHOD=POST>
<TABLE WIDTH=100% border=0 cellpadding=3 CELLSPACING=0>
<TR>
<TH><&|/l&>Update</&></TH>
%foreach my $col (@cols) {
% my $colalias = $col;
% $colalias =~ s/(Obj\-\>|)(Name|AsString)//;

<TH><% loc($colalias) %>&nbsp;</TH>
%}
</TR>

<%PERL>

my $i;

$Tickets->RedoSearch();
while (my $Ticket = $Tickets->Next) {
 $i++;
 if ($i % 2) {
     $bgcolor = "#dddddd";
 }
 else {
     $bgcolor = "#ffffff";
 }
      </%PERL>
<TR bgcolor="<%$bgcolor%>">
<TD><input type=checkbox name="UpdateTicket<%$Ticket->Id%>" CHECKED></TD>
%# The ticket view is controlled by config.pm, WebOptions
%foreach my $col (@cols) {
<TD>
% if ($col eq 'id') {
<A HREF="<% $RT::WebPath%>/Ticket/Display.html?id=<%$Ticket->Id%>"><%$Ticket->Id()%></A>
% }
%else {
<% eval "\$Ticket->$col()" %>&nbsp;
%}
</TD>
%}
</TR>
%}



</TABLE>

<HR>


<& /Elements/TitleBoxStart, title => loc('Update selected tickets') &>
<TABLE>
<TR>
<TD VALIGN=TOP>
<table>
<tr><td class=label> <&|/l&>Make Owner</&>: </td>
<td class=value> <& /Elements/SelectOwner, Name => "Owner" &> (<input type=checkbox name="ForceOwnerChange"> <&|/l&>Force change</&>) </td></tr>
<tr><td class=label> <&|/l&>Add Requestor</&>: </td>
<td class=value> <INPUT Name="AddRequestor" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Remove Requestor</&>: </td>
<td class=value> <INPUT Name="DeleteRequestor" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Add Cc</&>: </td>
<td class=value> <INPUT Name="AddCc" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Remove Cc</&>: </td>
<td class=value> <INPUT Name="DeleteCc" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Add AdminCc</&>: </td>
<td class=value> <INPUT Name="AddAdminCc" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Remove AdminCc</&>: </td>
<td class=value> <INPUT Name="DeleteAdminCc" SIZE=20> </td></tr>
</table>
</TD>
<TD VALIGN=TOP>
<table>
<tr><td class=label> <&|/l&>Make subject</&>: </td>
<td class=value> <INPUT Name="Subject" SIZE=20> </td></tr>
<tr><td class=label> <&|/l&>Make priority</&>: </td>
<td class=value> <INPUT Name="Priority" SIZE=4> </td></tr>
<tr><td class=label> <&|/l&>Make queue</&>: </td>
<td class=value> <& /Elements/SelectQueue, Name => "Queue" &> </td></tr>
<tr><td class=label> <&|/l&>Make Status</&>: </td>
<td class=value> <& /Elements/SelectStatus, Name => "Status" &> </td></tr>
<tr><td class=label> <&|/l&>Make date Starts</&>: </td>
<td class=value> <& /Elements/SelectDate, Name => "Starts_Date", ShowTime => 0, Default => '' &> </td></tr>
<tr><td class=label> <&|/l&>Make date Started</&>: </td>
<td class=value> <& /Elements/SelectDate, Name => "Started_Date", ShowTime => 0, Default => '' &> </td></tr>
<tr><td class=label> <&|/l&>Make date Told</&>: </td>
<td class=value> <& /Elements/SelectDate, Name => "Told_Date", ShowTime => 0, Default => '' &> </td></tr>
<tr><td class=label> <&|/l&>Make date Due</&>: </td>
<td class=value> <& /Elements/SelectDate, Name => "Due_Date", ShowTime => 0, Default => '' &> </td></tr>
<tr><td class=label> <&|/l&>Make date Resolved</&>: </td>
<td class=value> <& /Elements/SelectDate, Name => "Resolved_Date", ShowTime => 0, Default => '' &> </td></tr>
</table>

</TD>
</TR>
</table>
<& /Elements/TitleBoxEnd&>
<& /Elements/TitleBoxStart, title => loc('Add comments or replies to selected tickets') &>
<table>
<tr><td align=right><&|/l&>Update Type</&>:</td>
<td><select name="UpdateType">
  <option value="private" ><&|/l&>Comments (not sent to requestors)</&></option>
<option value="response" ><&|/l&>Reply to requestors</&></option>
</select> 
</td></tr>
<tr><td align=right><&|/l&>Subject</&>:</td><td> <input name="UpdateSubject" size=60 value=""></td></tr>
 <tr><td align=right><&|/l&>Attach</&>:</td><td><input name="UpdateAttachment" type="file"></td></tr>
 <tr><td class=labeltop><&|/l&>Message</&>:</td><td>
 <& /Elements/MessageBox, Name=>"UpdateContent"&>
 </td></tr>
 </table>

<table>
% foreach (keys %allcfs) {
<tr><td class=label>
%     my $cf = $allcfs{$_};
%     my $pref;
%     if ($cf->Queue == 0) {
%         $pref = "[Global]";
%     } else {
%         $pref = "[Queue: " . $cfqnames{$_} . "]";
%     }
<%$pref%> <b><% $cf->Name %></b><br>
<% $cf->FriendlyType %>
</td>
<td>
% if ($cf->Type ne "FreeformMultiple") {
<& /Ticket/Elements/EditCustomField, CustomField => $cf &>
% } else {
Add Values<br>
<textarea cols=15 rows=3 name="<%$cf->Id%>-Values"></textarea>
</td><td>
Delete Values<br>
<textarea cols=15 rows=3 name="<%$cf->Id%>-DeleteValues"></textarea>
% }    
</td>
</tr>
% }
</table>

<& /Elements/TitleBoxEnd &>

<& /Elements/TitleBoxStart, title => loc('Edit Links'), color => "#336633"&>
<i><&|/l&>Enter tickets or URIs to link tickets to. Seperate multiple entries with spaces.</&></i><br>
<& /Ticket/Elements/BulkLinks &>
<& /Elements/TitleBoxEnd &>

<& /Elements/Submit, Label => loc('Update All') &>


</FORM>
<%INIT>

# Iterate through the ARGS hash and remove anything with a null value.
map ($ARGS{$_} =~ /^$/ && (delete $ARGS{$_}), keys %ARGS);

my ($bgcolor, @results);
my @cols = qw(id Status Priority Subject QueueObj->Name OwnerObj->Name RequestorAddresses DueAsString );


my $Tickets = RT::Tickets->new($session{'CurrentUser'});
$Tickets->FromSQL($ARGS{'Query'});

Abort(loc("No search to operate on.")) unless ($Tickets);

my %allcfs;
my %cfqnames;
my %cfqs;
my $count = 0;
while (my $Ticket = $Tickets->Next) {
    my $cfq = $Ticket->QueueObj;
    my $cfqid = $cfq->Id;
    my $cfqn = $cfq->Name;
    unless ( exists $cfqs{$cfqid} ) {
	$cfqs{$cfqid} = 1;
	$count++;
	my $cfs = $cfq->CustomFields;
	while (my $cf = $cfs->Next) {
	    $allcfs{$cf->Id} = $cf;
	    $cfqnames{$cf->Id} = $cfqn;
	}
    }
}

my $do_comment_reply=0;
# Prepare for ticket updates
$ARGS{'UpdateContent'} =~ s/\r\n/\n/g;
chomp ($ARGS{'UpdateContent'}) ;

if ($ARGS{'UpdateContent'} &&
    $ARGS{'UpdateContent'} ne '' &&
    $ARGS{'UpdateContent'} ne  "-- \n" .
    $session{'CurrentUser'}->UserObj->Signature) {
            $do_comment_reply=1;
}

#Iterate through each ticket we've been handed
my @linkresults;

$Tickets->RedoSearch();
while (my $Ticket = $Tickets->Next) {
    $RT::Logger->debug( "Checking Ticket ".$Ticket->Id ."\n");
    next unless ($ARGS{"UpdateTicket".$Ticket->Id});
    $RT::Logger->debug ("Matched\n");
    my @updateresults; 
    if ($do_comment_reply) {
       ProcessUpdateMessage(TicketObj => $Ticket, ARGSRef => \%ARGS, Actions => \@updateresults); 
    }

    #Update the basics.
    my @basicresults = ProcessTicketBasics(TicketObj => $Ticket, ARGSRef => \%ARGS);
    my @dateresults = ProcessTicketDates(TicketObj => $Ticket, ARGSRef => \%ARGS);
    #Update the watchers
    my @watchresults = ProcessTicketWatchers(TicketObj => $Ticket, ARGSRef => \%ARGS);    

    #Update custom fields
    my $pat = "^(\\d+)-(.*)\$";
    foreach (keys %ARGS) {
	$ARGS{"Ticket-" . $Ticket->Id . "-CustomField-" . $1 . "-" . $2} = $ARGS{$_} if (/$pat/o);
    }
    my @cfresults = ProcessTicketCustomFieldUpdates(ARGSRef => \%ARGS);
    foreach (keys %ARGS) {
	delete $ARGS{"Ticket-" . $Ticket->Id . "-CustomField-" . $1 . "-" . $2} if (/$pat/o);
    }


    #Update the links
    $ARGS{'id'} = $Ticket;
    $ARGS{$Ticket->Id.'-MergeInto'} = $ARGS{'Ticket-MergeInto'};
    $ARGS{$Ticket->Id.'-DependsOn'} = $ARGS{'Ticket-DependsOn'};
    $ARGS{'DependsOn-'.$Ticket->Id} = $ARGS{'DependsOn-Ticket'};
    $ARGS{$Ticket->Id.'-MemberOf'} = $ARGS{'Ticket-MemberOf'};
    $ARGS{'MemberOf-'.$Ticket->Id} = $ARGS{'MemberOf-Ticket'};
    $ARGS{$Ticket->Id.'-RefersTo'} = $ARGS{'Ticket-RefersTo'};
    $ARGS{'RefersTo-'.$Ticket->Id} = $ARGS{'RefersTo-Ticket'};
    @linkresults = ProcessTicketLinks( TicketObj => $Ticket, ARGSRef => \%ARGS);
    delete $ARGS{'id'};
    delete $ARGS{$Ticket->Id.'-MergeInto'};
    delete $ARGS{$Ticket->Id.'-DependsOn'};
    delete $ARGS{'DependsOn-'.$Ticket->Id};
    delete $ARGS{$Ticket->Id.'-MemberOf'};
    delete $ARGS{'MemberOf-'.$Ticket->Id};
    delete $ARGS{$Ticket->Id.'-RefersTo'};
    delete $ARGS{'RefersTo-'.$Ticket->Id};
    
    my @tempresults = (@watchresults, @basicresults, @dateresults, @updateresults, @linkresults, @cfresults);
    @tempresults = map { loc("Ticket [_1]: [_2]",$Ticket->Id,$_) } @tempresults;

    @results = (@results, @tempresults);
}

</%INIT>
